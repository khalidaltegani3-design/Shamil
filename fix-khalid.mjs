import { initializeApp, getApps } from 'firebase/app';
import { getFirestore, doc, updateDoc, collection, getDocs, setDoc, query, where } from 'firebase/firestore';

// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
const firebaseConfig = {
  apiKey: "AIzaSyDKtxqu6YRoZQCeD9EoFmxAvc9JLi_d5R8",
  authDomain: "zoliapp-lite.firebaseapp.com",
  projectId: "zoliapp-lite",
  storageBucket: "zoliapp-lite.firebasestorage.app",
  messagingSenderId: "476068628948",
  appId: "1:476068628948:web:55c0eaf993de1cc553ee41"
};

const app = getApps().length === 0 ? initializeApp(firebaseConfig) : getApps()[0];
const db = getFirestore(app);

async function fixKhalidPermissions() {
  try {
    console.log('ðŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… khalid...');
    
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„
    const usersRef = collection(db, 'users');
    const q = query(usersRef, where('email', '==', 'end2012.19+1@gmail.com'));
    const querySnapshot = await getDocs(q);
    
    if (querySnapshot.empty) {
      console.log('âŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
      return false;
    }
    
    const userDoc = querySnapshot.docs[0];
    const userId = userDoc.id;
    const userData = userDoc.data();
    
    console.log('ðŸ“‹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠØ©:');
    console.log('   ID:', userId);
    console.log('   Ø§Ù„Ø¨Ø±ÙŠØ¯:', userData.email);
    console.log('   Ø§Ù„Ø§Ø³Ù…:', userData.displayName);
    console.log('   Ø§Ù„Ø¯ÙˆØ±:', userData.role);
    console.log('   Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ:', userData.homeDepartmentId);
    
    // ØªØ±Ù‚ÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ Ù…Ø´Ø±Ù
    const userRef = doc(db, 'users', userId);
    await updateDoc(userRef, {
      role: 'supervisor',
      homeDepartmentId: 'general-monitoring',
      updatedAt: new Date()
    });
    
    console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¯ÙˆØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ Ù…Ø´Ø±Ù');
    
    // Ø¥Ø¶Ø§ÙØ© ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¥Ø´Ø±Ø§Ù Ø¹Ù„Ù‰ Ù‚Ø³Ù… Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¹Ø§Ù…Ø©
    const supervisorRef = doc(db, 'departments', 'general-monitoring', 'supervisors', userId);
    await setDoc(supervisorRef, {
      assignedAt: new Date(),
      assignedBy: 'system_admin',
      active: true
    });
    
    console.log('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¥Ø´Ø±Ø§Ù Ø¹Ù„Ù‰ Ù‚Ø³Ù… Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¹Ø§Ù…Ø©');
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
    const updatedUserDoc = await userDoc.ref.get();
    if (updatedUserDoc.exists()) {
      console.log('ðŸ“‹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«:', updatedUserDoc.data());
    }
    
    return true;
    
  } catch (error) {
    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª:', error);
    return false;
  }
}

// ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¥ØµÙ„Ø§Ø­
fixKhalidPermissions().then((success) => {
  if (success) {
    console.log('ðŸŽ‰ ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­! ÙŠØ¬Ø¨ Ø§Ù„Ø¢Ù† Ø£Ù† ØªØ¹Ù…Ù„ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø®Ø§Ù„Ø¯');
  } else {
    console.log('âŒ ÙØ´Ù„Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©');
  }
}).catch((error) => {
  console.error('Ø®Ø·Ø£:', error);
}).finally(() => {
  process.exit(0);
});